# Тестирование React приложений

Привет! Здесь собрана информация и примеры для подготовки к тестированию React приложений.

1. [Подготовка](#подготовка)
   1. [Настройка](#настройка)
   2. [Расположение и название тестовых файлов](#расположение-и-название-тестовых-файлов)
2. [Изучение](#изучение)
   1. [Что тестировать?](#что-тестировать)
   2. [Что не тестировать?](#что-не-тестировать)
   3. [Что использовать?](#что-использовать)
   4. [Как правильно тестировать?](#как-правильно-тестировать)
        1. [Почему нельзя тестировать реализацию?](#почему-нельзя-тестировать-реализацию)
        2. [Как найти нужный DOM элемент?](#как-найти-нужный-dom-элемент)
        3. [Как работать с состоянием компонента?](#как-работать-с-состоянием-компонента)
3. [Полезные материалы](#полезные-материалы)

## Подготовка

### Настройка

Необходимые `npm пакеты`:

- jest
- nock
- @testing-library/jest-dom
- @testing-library/react
- @testing-library/user-event
- babel-jest
- eslint-plugin-jest

Файлы `jest.config.js`, `jest.setup.js`, `.eslintrc.js`, `.babelrc` содержат конфигурацию, необходимую для тестирования. Они готовы к использованию в проектах в текущем или доработанном виде.

В папке `examples` лежат примеры различных компонентов и кейсов для тестирования.

### Расположение и название тестовых файлов

В проекте файлы с тестами располагаются либо в папке своего компонента, либо в папке `/tests` в корневой директории. Папка `/tests` содержит тесты страниц (`/pages`), функций-хелперов (`/helpers`) и др.

Название тестового файла компонента:\
`ComponentName.test.js`

Название тестового файла функции:\
`functionName.test.js`

## Изучение

### Что тестировать?

В первую очередь, работоспособность компонентов и взаимодействие с приложением от лица юзера. Нажатие на кнопки, заполнение форм, успешный рендер компонентов с пропсами, открытие модалок, подзагрузка элементов и др. То, что в первую очередь связано с UX.

### Что не тестировать?

То, что не влияет на взаимодействие с приложением. Мелочи вроде названия функций и переменных, типы props, стили, сторонние библиотеки и др.

Функции мокаются (_mock_) в самом базовом виде, они не импортируются и не копируются до оригинала. Оставляем только базовую логику.

Сторонние библиотеки (например, _Яндекс Карты_) имеют свои тесты. В наших мы можем либо полностью их заменить (используя заглушку типа _\</ div>_), либо протестировать только самую необходимую логику (например, отправку форм из _Formik_).

### Что использовать?

Для рендера и поиска элементов используется библиотека [@testing-library/react](https://testing-library.com/docs/react-testing-library/intro).

Для проверки содержимого и состояния DOM элементов используется [jest-dom](github.com/testing-library/jest-dom)

Для работы с событиями используется [@testing-library/user-event](https://testing-library.com/docs/ecosystem-user-event/).

Для подделывания запросов к API используется [Nock](github.com/nock/nock).

Синтаксис тестов и основные методы для работы с ними обеспечивает [Jest](https://jestjs.io/docs/getting-started)

### Как правильно тестировать?

Далее список часто встречающихся вопросов:

#### Почему нельзя тестировать реализацию?

Такой подход ведет к высокому шансу на то, что тест будет давать неверные результаты. Компонент может работать абсолютно верно, но тест будет говорить обратное (False negatives). Компонент может не работать, но тест будет успешно пройден (False positives). И шансы на ошибку возрастают при каждом малейшем рефакторе кода.

Поэтому мы не тестируем реализацию, а только *результат*. То, что в конечно итоге дойдет до пользователя и будет непосредственно влиять на его опыт. По этой же причине мы не тестируем [снимками](https://jestjs.io/docs/snapshot-testing). Стоит ли говорить, что такой подход к тестированию так же напомного приятнее и быстрее?

#### Как найти нужный DOM элемент?

Используем запросы `(queries)` от библиотеки [@testing-library/react](https://testing-library.com/docs/react-testing-library/cheatsheet#queries).

- Для элементов с определенной `aria` ролью используем `...ByRole` запросы.\
    Например:

    `screen.getByRole('button', { name: 'Some text' })`

    Так мы, во-первых, будем уверены в том, что найденный элемент является кнопкой, а во-вторых, проверяем его же доступность. Список [ARIA Roles](https://developer.mozilla.org/en-US/docs/Web/Accessibility/ARIA/Roles).

- Для разных элементов есть более подходящие `queries`, чем другие. Например, для полей форм лучше использовать `getByLabelText`. 
- Различия между `getBy...`, `queryBy...` и `findBy...`:
    * `getBy...` находит элемент и выбрасывает ошибку, если он не найден.
    * `queryBy...` находит элемент и возвращает `null`, если он не найден (удобно для проверки на отсутствие).
    * `findBy...` возвращает выполненный промис, если элемент был найден за определенное время (удобно в случае, когда элемент рендерится не сразу).
- Для получения сразу нескольких элементов используем `getByAll...`, `queryByAll...` и `findByAll...`.

#### Как работать с состоянием компонента?

С оригинальным `state` компонента не работаем и не обращаемся к нему напрямую. Проверяем и оцениваем только результат его работы.

Пример: `/examples/stateful-component`.

## Полезные материалы

В материалах могут встречаться другие библиотеки или методы тестирования. Поэтому этот список нужен преимущественно для ознакомления с логикой написания тестов, а за примерами иногда лучше заглянуть в `/examples`.

- [Введение в тестирование](https://www.freecodecamp.org/news/testing-react-hooks/) (есть устаревшее)
- [Современные методы тестирования](https://blog.sapegin.me/all/react-testing-3-jest-and-react-testing-library/)
- [Распространенные ошибки и их решения](https://kentcdodds.com/blog/common-mistakes-with-react-testing-library)
- [Почему нужно тестировать результат, а не реализацию](https://kentcdodds.com/blog/testing-implementation-details)
- [Список `expect` методов библиотеки Jest](https://jestjs.io/docs/expect)
- [Список сопоставителей `(matchers)` библиотеки jest-dom](https://github.com/testing-library/jest-dom)

Советую почитать материалы от [Kent C. Dodds](https://kentcdodds.com/blog/?q=testing), одного из лучших знатоков тестирования.
