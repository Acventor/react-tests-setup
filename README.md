# Тестирование React приложений

Привет! Здесь собрана информация и примеры для подготовки к тестированию React приложений.

1. [Подготовка](#подготовка)
   1. [Настройка](#настройка)
   2. [Расположение и название тестовых файлов](#расположение-и-название-тестовых-файлов)
   3. [Основной синтаксис тестов](#основной-синтаксис-тестов)
2. [Вступление](#вступление)
   1. [Что тестировать?](#что-тестировать)
   2. [Что не тестировать?](#что-не-тестировать)
   3. [Что использовать?](#что-использовать)
3. [Частые вопросы](#частые-вопросы)
    1. [Почему не стоит тестировать реализацию?](#почему-не-стоит-тестировать-реализацию)
    2. [Как найти нужный DOM элемент?](#как-найти-нужный-dom-элемент)
    3. [Как работать с состоянием компонента?](#как-работать-с-состоянием-компонента)
3. [Полезные материалы](#полезные-материалы)

## Подготовка

### Настройка

Необходимые `npm пакеты`:

- jest
- nock
- @testing-library/jest-dom
- @testing-library/react
- @testing-library/user-event
- babel-jest
- eslint-plugin-jest

Файлы `jest.config.js`, `jest.setup.js`, `.eslintrc.js`, `.babelrc` содержат конфигурацию, необходимую для тестирования. Они готовы к использованию в проектах в текущем или доработанном виде.

В папке `examples` лежат примеры различных компонентов и кейсов для тестирования.

### Расположение и название тестовых файлов

В проекте файлы с тестами располагаются либо в папке своего компонента, либо в папке `/tests` в корневой директории. Папка `/tests` содержит тесты страниц (`/pages`), функций-хелперов (`/helpers`) и др.

Название тестового файла компонента:\
`ComponentName.test.js`

Название тестового файла функции:\
`functionName.test.js`

### Основной синтаксис тестов

Каждый тест оборачивается в функцию `it()`:
```js
it('sends request on submit', () => {...})
```

Тесты можно группировать в смысловые блоки с помощью `describe()`:
```js
describe('Main logic tests', () => {
    it('does something', () => {...})
})
```

## Вступление

### Что тестировать?

В первую очередь, работоспособность компонентов и взаимодействие с приложением от лица юзера. Нажатие на кнопки, заполнение форм, успешный рендер компонентов с пропсами, открытие модалок, подзагрузка элементов и др. То, что в первую очередь связано с UX.

### Что не тестировать?

То, что не влияет на взаимодействие с приложением. Мелочи вроде названия функций и переменных, типы props, стили, сторонние библиотеки и др.

Функции мокаются (_mock_) в самом базовом виде, они не импортируются и не копируются до оригинала. Оставляем только базовую логику.

Сторонние библиотеки (например, _Яндекс Карты_) имеют свои тесты. В наших мы можем либо полностью их заменить (используя заглушку типа _\</ div>_), либо протестировать только самую необходимую логику (например, отправку форм из _Formik_).

### Что использовать?

Для рендера и поиска элементов используется библиотека [@testing-library/react](https://testing-library.com/docs/react-testing-library/intro).

Для проверки содержимого и состояния DOM элементов используется [jest-dom](github.com/testing-library/jest-dom)

Для работы с событиями используется [@testing-library/user-event](https://testing-library.com/docs/ecosystem-user-event/).

Для подделывания запросов к API используется [Nock](github.com/nock/nock).

Синтаксис тестов и основные методы для работы с ними обеспечивает [Jest](https://jestjs.io/docs/getting-started)

## Частые вопросы

### Почему не стоит тестировать реализацию?

Такой подход ведет к высокому шансу на то, что тест будет давать неверные результаты. Допустим, компонент может работать абсолютно верно, но тест будет говорить обратное (*False negatives*). Или компонент может не работать, но тест будет успешно пройден (*False positives*). И шансы на такие ошибки возрастают при малейшем рефакторе кода.

Поэтому мы тестируем *результат*, а не реализацию. Работаем именно с тем, что в конечно итоге дойдет до пользователя и будет непосредственно влиять на его опыт. По этой же причине мы не тестируем [снимками](https://jestjs.io/docs/snapshot-testing). Особенно приятно, что такой подход не только надежнее, но и проще в реализации и поддержке.

Подробнее на эту тему можно почитать в [этом материале](https://kentcdodds.com/blog/testing-implementation-details).

### Как найти нужный DOM элемент?

Используем запросы `(queries)` от библиотеки [@testing-library/react](https://testing-library.com/docs/react-testing-library/cheatsheet#queries).

- Для элементов с определенной `aria` ролью используем `...ByRole` запросы.\
    Например:
    ```js
    screen.getByRole('button', { name: 'Some text' });
    ```

    В этом примере мы, во-первых, будем уверены в том, что найденный элемент является именно кнопкой, а во-вторых, проверяем ее же доступность. Список [ARIA Roles](https://developer.mozilla.org/en-US/docs/Web/Accessibility/ARIA/Roles).

- Для разных элементов есть более подходящие `queries`, чем другие. Например, для полей форм лучше использовать `getByLabelText`. 
- Различия между `getBy...`, `queryBy...` и `findBy...`:
    * `getBy...` находит элемент и выбрасывает ошибку, если он не найден.
    * `queryBy...` находит элемент и возвращает `null`, если он не найден (удобно для проверки на отсутствие).
    * `findBy...` возвращает выполненный промис, если элемент был найден за определенное время (удобно в случае, когда элемент рендерится не сразу).
- Для получения сразу нескольких элементов используем `getByAll...`, `queryByAll...` и `findByAll...`.

### Как работать с состоянием компонента?

Оригинальный `state` компонента не используем и не обращаемся к нему напрямую. Проверяем и оцениваем только результат его работы.

Пример есть в `/examples/component-with-state`.

## Полезные материалы

В материалах могут встречаться другие библиотеки или методы тестирования. Поэтому этот список нужен преимущественно для ознакомления с логикой написания тестов, а за примерами иногда лучше заглянуть в `/examples`.

- [Введение в тестирование](https://www.freecodecamp.org/news/testing-react-hooks/) (есть устаревшее)
- [Современные методы тестирования](https://blog.sapegin.me/all/react-testing-3-jest-and-react-testing-library/)
- [Распространенные ошибки и их решения](https://kentcdodds.com/blog/common-mistakes-with-react-testing-library)
- [Почему нужно тестировать результат, а не реализацию](https://kentcdodds.com/blog/testing-implementation-details)
- [Список `expect` методов библиотеки Jest](https://jestjs.io/docs/expect)
- [Список сопоставителей `(matchers)` библиотеки jest-dom](https://github.com/testing-library/jest-dom)

Так же советую почитать материалы от одного из лучших знатоков тестирования – [Kent C. Dodds](https://kentcdodds.com/blog/?q=testing).
